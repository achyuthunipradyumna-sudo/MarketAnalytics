<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>Market Breadth â€“ Heatmap</title>

<style>
body {
  font-family: -apple-system, BlinkMacSystemFont, Arial, sans-serif;
  margin: 16px;
}

h2 { margin-bottom: 10px; }

.controls {
  margin-bottom: 12px;
}

button, select {
  padding: 6px 10px;
  margin-right: 6px;
  font-size: 14px;
  cursor: pointer;
}

table {
  border-collapse: collapse;
  width: 100%;
  font-size: 12px;
}

th, td {
  border: 1px solid #ddd;
  padding: 4px 6px;
  text-align: right;
}

th {
  background: #f5f5f5;
  position: sticky;
  top: 0;
  z-index: 2;
}

td.date {
  text-align: left;
  background: #fafafa;
  font-weight: 600;
}

/* ---------- Z SCORE COLORS ---------- */
.z-pos-strong { background:#1a9850; color:white; }
.z-pos        { background:#91cf60; }
.z-neutral    { background:#f7f7f7; }
.z-neg        { background:#fc8d59; }
.z-neg-strong { background:#d73027; color:white; }

/* ---------- RAW % COLORS ---------- */
.raw-pct-strong { background:#1a9850; color:white; }
.raw-pct-pos    { background:#91cf60; }
.raw-pct-mid    { background:#f7f7f7; }
.raw-pct-neg    { background:#fdae61; }
.raw-pct-bad    { background:#d73027; color:white; }

/* ---------- RAW COUNT COLORS ---------- */
.raw-pos { background:#a6d96a; }
.raw-neg { background:#f46d43; color:white; }
.raw-zero { background:#f7f7f7; }
</style>
</head>

<body>

<h2>ðŸ“Š Market Breadth â€” Participation & Internal Strength</h2>

<div class="controls">
  View:
  <button onclick="setMode('raw')">Raw</button>
  <button onclick="setMode('z')">Z-Scores</button>

  Lookback:
  <select onchange="setLookback(this.value)">
    <option value="21">1 Month</option>
    <option value="63">3 Months</option>
    <option value="126">6 Months</option>
    <option value="252">1 Year</option>
    <option value="all" selected>Full History</option>
  </select>
</div>

<div id="table"></div>

<script>
let DATA = [];
let MODE = "raw";
let LOOKBACK = "all";

/* -------- COLUMN DEFINITIONS -------- */
const RAW_COLS = [
  {k:"adv", l:"Adv"},
  {k:"dec", l:"Dec"},
  {k:"ad",  l:"Net A/D"},
  {k:"pct_above_20dma",  l:"% > 20DMA"},
  {k:"pct_above_50dma",  l:"% > 50DMA"},
  {k:"pct_above_200dma", l:"% > 200DMA"},
  {k:"nh", l:"NH"},
  {k:"nl", l:"NL"},
  {k:"nhnl", l:"NHâ€“NL"}
];

const Z_COLS = [
  {k:"ad_z_50", l:"A/D Z(50)"},
  {k:"pct_above_20dma_z", l:"%>20DMA Z"},
  {k:"pct_above_50dma_z", l:"%>50DMA Z"},
  {k:"pct_above_200dma_z", l:"%>200DMA Z"},
  {k:"nhnl_z", l:"NHâ€“NL Z"}
];

/* -------- FETCH DATA -------- */
fetch("data/history/breadth_full_history.csv")
.then(r => r.text())
.then(text => {
  const rows = text.trim().split("\n");
  const headers = rows[0].split(",");
  DATA = rows.slice(1).map(r => {
    const v = r.split(",");
    let o = {};
    headers.forEach((h,i)=>o[h]=v[i]);
    return o;
  }).reverse(); // ðŸ”‘ LATEST DATE ON TOP
  render();
});

function setMode(m){ MODE=m; render(); }
function setLookback(l){ LOOKBACK=l; render(); }

/* -------- COLOR LOGIC -------- */
function zClass(v){
  v = parseFloat(v);
  if (v >= 1.5) return "z-pos-strong";
  if (v >= 0.5) return "z-pos";
  if (v > -0.5) return "z-neutral";
  if (v > -1.5) return "z-neg";
  return "z-neg-strong";
}

function rawPctClass(v){
  v = parseFloat(v);
  if (v >= 70) return "raw-pct-strong";
  if (v >= 55) return "raw-pct-pos";
  if (v >= 45) return "raw-pct-mid";
  if (v >= 30) return "raw-pct-neg";
  return "raw-pct-bad";
}

function rawCountClass(v){
  v = parseInt(v);
  if (v > 0) return "raw-pos";
  if (v < 0) return "raw-neg";
  return "raw-zero";
}

/* -------- RENDER -------- */
function render(){
  let rows = DATA;
  if (LOOKBACK !== "all"){
    rows = rows.slice(0, parseInt(LOOKBACK));
  }

  const cols = MODE==="z" ? Z_COLS : RAW_COLS;

  let html = "<table><tr><th>Date</th>";
  cols.forEach(c=>html+=`<th>${c.l}</th>`);
  html+="</tr>";

  rows.forEach(r=>{
    html+=`<tr><td class="date">${r.Date}</td>`;
    cols.forEach(c=>{
      let val = r[c.k];
      if (!val) val = "";

      let cls="";
      if (MODE==="z") cls = zClass(val);
      else if (c.k.includes("pct_above")) cls = rawPctClass(val);
      else cls = rawCountClass(val);

      let disp = val;
      if (c.k.includes("pct_above")) disp = (+val).toFixed(2);
      else if (!isNaN(val)) disp = Math.round(val);

      html+=`<td class="${cls}">${disp}</td>`;
    });
    html+="</tr>";
  });

  html+="</table>";
  document.getElementById("table").innerHTML = html;
}
</script>

</body>
</html>