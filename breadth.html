<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8" />
<title>Breadth — Participation & Internal Strength</title>

<style>
body {
  font-family: -apple-system, BlinkMacSystemFont, Arial, sans-serif;
  margin: 16px;
}

h2 { margin-bottom: 8px; }

.controls {
  margin-bottom: 12px;
}

select {
  padding: 6px;
  font-size: 14px;
}

table {
  border-collapse: collapse;
  width: 100%;
  font-size: 12px;
}

th, td {
  border: 1px solid #ddd;
  padding: 4px 6px;
  text-align: right;
}

th {
  position: sticky;
  top: 0;
  background: #f5f5f5;
  z-index: 2;
}

td.date {
  position: sticky;
  left: 0;
  background: #fff;
  text-align: left;
  z-index: 1;
}

.green { background: #d6f5d6; }
.red   { background: #f8d7da; }
.neutral { background: #eee; }
</style>
</head>

<body>

<h2>Breadth — Participation & Internal Strength</h2>

<div class="controls">
  View:
  <select id="mode">
    <option value="z">Z-Scores</option>
    <option value="raw">Raw %</option>
    <option value="chg">Δ 20-Day</option>
  </select>
</div>

<table id="table"></table>

<script>
const DATA_URL = "data/history/breadth_full_history.csv";

let rows = [];
let headers = [];

fetch(DATA_URL)
  .then(r => r.text())
  .then(text => {
    const lines = text.trim().split("\n");
    headers = lines[0].split(",");
    rows = lines.slice(1).map(l => {
      const v = l.split(",");
      let o = {};
      headers.forEach((h, i) => o[h] = parseFloat(v[i]) || v[i]);
      return o;
    });
    render();
  });

function color(v) {
  if (v > 1) return "green";
  if (v < -1) return "red";
  return "neutral";
}

function render() {
  const mode = document.getElementById("mode").value;
  const tbl = document.getElementById("table");
  tbl.innerHTML = "";

  const cols = [
    "Date",
    "ad_z_50",
    "pct_above_20dma_" + mode,
    "pct_above_50dma_" + mode,
    "pct_above_200dma_" + mode,
    "nhnl_z",
    "median_stock_vol_20_z"
  ].filter(c => headers.includes(c));

  // Header
  const trh = document.createElement("tr");
  cols.forEach(c => {
    const th = document.createElement("th");
    th.innerText = c.replaceAll("_", " ");
    trh.appendChild(th);
  });
  tbl.appendChild(trh);

  // Rows
  rows.slice(-260).reverse().forEach(r => {
    const tr = document.createElement("tr");
    cols.forEach(c => {
      const td = document.createElement("td");
      if (c === "Date") {
        td.innerText = r[c];
        td.className = "date";
      } else {
        const v = r[c];
        td.innerText = isNaN(v) ? "" : v.toFixed(2);
        td.className = color(v);
      }
      tr.appendChild(td);
    });
    tbl.appendChild(tr);
  });
}

document.getElementById("mode").onchange = render;
</script>

</body>
</html>