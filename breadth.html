<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Market Breadth – Heatmap</title>

<style>
body {
  font-family: system-ui, -apple-system, Segoe UI, Arial, sans-serif;
  padding: 16px;
}

h2 {
  margin-bottom: 10px;
}

.controls {
  margin-bottom: 12px;
}

button {
  padding: 6px 10px;
  margin-right: 6px;
  border: 1px solid #ccc;
  background: #f5f5f5;
  cursor: pointer;
}

button.active {
  background: #ddd;
  font-weight: 600;
}

table {
  border-collapse: collapse;
  font-size: 12px;
  width: 100%;
}

th, td {
  border: 1px solid #ddd;
  padding: 4px 8px;
  text-align: right;
  white-space: nowrap;
}

th {
  background: #f2f2f2;
  position: sticky;
  top: 0;
  z-index: 2;
}

td.date {
  text-align: left;
  font-weight: 600;
  background: #fafafa;
  position: sticky;
  left: 0;
  z-index: 1;
}

/* ===== Excel pastel heatmap palette ===== */
.bkt-0  { background:#F8696B; }
.bkt-1  { background:#F4A582; }
.bkt-2  { background:#FDDCC8; }
.bkt-3  { background:#FDEEEE; }
.bkt-4  { background:#FFF5F5; }
.bkt-5  { background:#FFFFFF; }
.bkt-6  { background:#F4FBF2; }
.bkt-7  { background:#D9F0D3; }
.bkt-8  { background:#A6D96A; }
.bkt-9  { background:#63BE7B; }
.bkt-10 { background:#3FA35A; }

td {
  color: #000;
}
</style>
</head>

<body>

<h2>Market Breadth — Participation & Internal Strength</h2>

<div class="controls">
  View:
  <button id="btn1"  onclick="setRange(1)">1M</button>
  <button id="btn3"  onclick="setRange(3)">3M</button>
  <button id="btn6"  onclick="setRange(6)" class="active">6M</button>
  <button id="btn12" onclick="setRange(12)">1Y</button>
  <button id="btn36" onclick="setRange(36)">3Y</button>
</div>

<table id="heatmap"></table>

<script>
/* ================= CONFIG ================= */
const CSV_PATH = "data/history/breadth_full_history.csv";

const COLUMNS = [
  { key:"adv", label:"Adv" },
  { key:"dec", label:"Dec" },
  { key:"ad", label:"Net A/D" },
  { key:"pct_above_20dma", label:"% > 20DMA", heat:true },
  { key:"pct_above_50dma", label:"% > 50DMA", heat:true },
  { key:"pct_above_200dma", label:"% > 200DMA", heat:true },
  { key:"nh", label:"NH" },
  { key:"nl", label:"NL" },
  { key:"nhnl", label:"NH–NL" }
];

let FULL_DATA = [];
let RANGE_CACHE = {};
let CURRENT_RANGE = 6;

/* ================= HEATMAP BUCKET ================= */
function bucket(v) {
  if (v < 10) return 0;
  if (v < 20) return 1;
  if (v < 30) return 2;
  if (v < 40) return 3;
  if (v < 45) return 4;
  if (v <= 55) return 5;   // neutral white
  if (v <= 60) return 6;
  if (v <= 70) return 7;
  if (v <= 80) return 8;
  if (v <= 90) return 9;
  return 10;
}

/* ================= CSV PARSER ================= */
function parseCSV(text) {
  const lines = text.trim().split("\n");
  const headers = lines[0].split(",");
  return lines.slice(1).map(r => {
    const vals = r.split(",");
    const o = {};
    headers.forEach((h,i)=>o[h]=vals[i]);
    return o;
  });
}

/* ================= BUILD HEADER (ONCE) ================= */
function buildHeader() {
  const table = document.getElementById("heatmap");

  const thead = document.createElement("thead");
  const tr = document.createElement("tr");

  const thDate = document.createElement("th");
  thDate.textContent = "Date";
  tr.appendChild(thDate);

  COLUMNS.forEach(c=>{
    const th = document.createElement("th");
    th.textContent = c.label;
    tr.appendChild(th);
  });

  thead.appendChild(tr);
  table.appendChild(thead);
  table.appendChild(document.createElement("tbody"));
}

/* ================= PRE-COMPUTE TIME RANGES ================= */
function prepareRanges() {
  const latest = new Date(FULL_DATA[FULL_DATA.length - 1].Date);

  [1,3,6,12,36].forEach(m=>{
    const cutoff = new Date(latest);
    cutoff.setMonth(cutoff.getMonth() - m);

    RANGE_CACHE[m] = FULL_DATA
      .filter(r => new Date(r.Date) >= cutoff)
      .reverse(); // latest on top
  });
}

/* ================= RENDER BODY ONLY ================= */
function renderBody(months) {
  const tbody = document.querySelector("#heatmap tbody");
  tbody.innerHTML = "";

  const frag = document.createDocumentFragment();

  RANGE_CACHE[months].forEach(row=>{
    const tr = document.createElement("tr");

    const tdDate = document.createElement("td");
    tdDate.textContent = row.Date;
    tdDate.className = "date";
    tr.appendChild(tdDate);

    COLUMNS.forEach(c=>{
      const td = document.createElement("td");
      const v = parseFloat(row[c.key]);

      if (!isNaN(v)) {
        td.textContent = c.heat ? v.toFixed(2) : Math.round(v);
        if (c.heat) td.className = "bkt-" + bucket(v);
      }
      tr.appendChild(td);
    });

    frag.appendChild(tr);
  });

  tbody.appendChild(frag);
}

/* ================= RANGE CONTROL ================= */
function setRange(m) {
  CURRENT_RANGE = m;
  document.querySelectorAll("button").forEach(b=>b.classList.remove("active"));
  document.getElementById("btn"+m).classList.add("active");
  requestAnimationFrame(()=>renderBody(m));
}

/* ================= LOAD ================= */
fetch(CSV_PATH)
  .then(r=>r.text())
  .then(text=>{
    FULL_DATA = parseCSV(text);
    buildHeader();
    prepareRanges();
    renderBody(CURRENT_RANGE);
  })
  .catch(err=>{
    document.body.innerHTML += "<p style='color:red'>Failed to load CSV</p>";
    console.error(err);
  });
</script>

</body>
</html>