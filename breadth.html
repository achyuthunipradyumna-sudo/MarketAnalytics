<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8" />
<title>Breadth Heatmap â€“ Market State</title>

<style>
body {
  font-family: Arial, sans-serif;
  margin: 20px;
}

h2 {
  margin-bottom: 10px;
}

.controls {
  margin-bottom: 12px;
}

select {
  padding: 6px;
  font-size: 14px;
}

table {
  border-collapse: collapse;
  width: 100%;
  font-size: 12px;
}

th, td {
  border: 1px solid #ddd;
  padding: 6px;
  text-align: center;
}

th {
  position: sticky;
  top: 0;
  background: #f5f5f5;
  z-index: 2;
}

td.date {
  font-weight: bold;
  background: #fafafa;
}

.green { background-color: #b6e3b6; }
.lightgreen { background-color: #dff2df; }
.red { background-color: #f4b6b6; }
.lightred { background-color: #fde0e0; }
.neutral { background-color: #ffffff; }

</style>
</head>

<body>

<h2>ðŸ“Š Market Breadth â€“ Daily Heatmap</h2>

<div class="controls">
  View:
  <select id="mode">
    <option value="z">Z-Scores</option>
    <option value="raw">Raw Values</option>
  </select>

  Lookback:
  <select id="window">
    <option value="30">1 Month</option>
    <option value="90">3 Months</option>
    <option value="180">6 Months</option>
    <option value="260">1 Year</option>
    <option value="all">Full History</option>
  </select>
</div>

<div id="table"></div>

<script>
const CSV_PATH = "data/history/breadth_full_history.csv";

fetch(CSV_PATH)
  .then(r => r.text())
  .then(text => {
    const rows = text.trim().split("\n");
    const header = rows[0].split(",");
    const data = rows.slice(1).map(r => {
      const v = r.split(",");
      let o = {};
      header.forEach((h, i) => o[h] = v[i]);
      return o;
    });

    window.fullData = data;
    render();
  });

function colorZ(v) {
  if (v >= 1.0) return "green";
  if (v >= 0.3) return "lightgreen";
  if (v <= -1.0) return "red";
  if (v <= -0.3) return "lightred";
  return "neutral";
}

function colorRaw(v) {
  if (v >= 70) return "green";
  if (v >= 55) return "lightgreen";
  if (v <= 30) return "red";
  if (v <= 45) return "lightred";
  return "neutral";
}

function render() {
  const mode = document.getElementById("mode").value;
  const windowSel = document.getElementById("window").value;

  let data = [...window.fullData];
  if (windowSel !== "all") {
    data = data.slice(-parseInt(windowSel));
  }

  let html = "<table><tr>";
  html += "<th>Date</th>";
  html += "<th>AD Z</th>";
  html += "<th>%>20DMA</th>";
  html += "<th>Î”20DMA</th>";
  html += "<th>%>50DMA</th>";
  html += "<th>Î”50DMA</th>";
  html += "<th>%>200DMA</th>";
  html += "<th>Î”200DMA</th>";
  html += "<th>NHâ€“NL Z</th>";
  html += "</tr>";

  data.forEach(d => {
    html += `<tr><td class="date">${d.Date}</td>`;

    const cells = [
      ["ad_z_50", true],
      ["pct_above_20dma", false],
      ["pct_above_20dma_chg", false],
      ["pct_above_50dma", false],
      ["pct_above_50dma_chg", false],
      ["pct_above_200dma", false],
      ["pct_above_200dma_chg", false],
      ["nhnl_z", true]
    ];

    cells.forEach(([k, isZ]) => {
      const val = parseFloat(d[k] || d[`${k}_z`] || 0);
      const cls = mode === "z" || isZ
        ? colorZ(val)
        : colorRaw(val);

      html += `<td class="${cls}">${isNaN(val) ? "" : val.toFixed(2)}</td>`;
    });

    html += "</tr>";
  });

  html += "</table>";
  document.getElementById("table").innerHTML = html;
}

document.getElementById("mode").onchange = render;
document.getElementById("window").onchange = render;
</script>

</body>
</html>
