<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Market Breadth Heatmap</title>

<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

<style>
body {
  font-family: system-ui, -apple-system, Segoe UI, Arial, sans-serif;
  margin: 14px;
}

h2 { margin-bottom: 6px; }

.controls {
  margin-bottom: 10px;
}

button {
  padding: 6px 10px;
  margin-right: 6px;
  border: 1px solid #ccc;
  background: #f5f5f5;
  cursor: pointer;
}
button.active {
  background: #ddd;
  font-weight: 600;
}

/* ===== Table ===== */
.table-wrap {
  max-height: 78vh;
  overflow: auto;
  border: 1px solid #ddd;
}

table {
  border-collapse: collapse;
  font-size: 12px;
  width: max-content;
}

th, td {
  border: 1px solid #ddd;
  padding: 4px 6px;
  text-align: right;
  white-space: nowrap;
}

th {
  background: #f3f3f3;
  position: sticky;
  top: 0;
  z-index: 2;
}
/* ===== Brighter Excel-style heatmap palette ===== */
.bkt-0  { background:#F44336; }  /* strong red */
.bkt-1  { background:#F77B72; }
.bkt-2  { background:#F9B4AD; }
.bkt-3  { background:#FCDDD9; }
.bkt-4  { background:#FFF0EE; }
.bkt-5  { background:#FFFFFF; }
.bkt-6  { background:#EAF6EA; }
.bkt-7  { background:#C9EBC9; }
.bkt-8  { background:#9EDB9E; }
.bkt-9  { background:#5FBF73; }
.bkt-10 { background:#2E9E5E; } /* strong green */
</style>
</head>

<body>
<h2>Market Breadth â€“ Heatmap</h2>

<div class="controls">
  <button onclick="setRange(1)">1M</button>
  <button onclick="setRange(3)">3M</button>
  <button onclick="setRange(6)">6M</button>
  <button onclick="setRange(12)">1Y</button>
  <button onclick="setRange(24)">2Y</button>
  <button onclick="setRange(36)">3Y</button>
  <button onclick="setRange(0)" class="active">Full</button>
</div>

<div class="table-wrap">
  <table id="tbl"></table>
</div>

<script>
/* ================= CONFIG ================= */
const CSV_PATH = "data/history/breadth_full_history.csv";
const MAX_ROWS_RENDER = 800;   // keeps DOM fast
const Z_COL_SUFFIX = "_z";

/* ================= STATE ================= */
let rawData = [];
let headers = [];

/* ================= LOAD CSV ================= */
Papa.parse(CSV_PATH, {
  download: true,
  header: true,
  dynamicTyping: true,
  skipEmptyLines: true,
  worker: true,
  complete: res => {
    rawData = res.data.sort((a,b)=> new Date(b.Date) - new Date(a.Date));
    headers = res.meta.fields;
    render(rawData);
  }
});

/* ================= TIME RANGE ================= */
function setRange(months) {
  document.querySelectorAll("button").forEach(b=>b.classList.remove("active"));
  event.target.classList.add("active");

  if (months === 0) {
    render(rawData);
    return;
  }

  const cutoff = new Date();
  cutoff.setMonth(cutoff.getMonth() - months);
  render(rawData.filter(r => new Date(r.Date) >= cutoff));
}

/* ================= HEATMAP ================= */
function bucket(v) {
  if (v === null || v === undefined || isNaN(v)) return "";
  const z = Math.max(-3, Math.min(3, v));
  return "bkt-" + Math.round(((z + 3) / 6) * 10);
}

/* ================= RENDER ================= */
function render(data) {
  const tbl = document.getElementById("tbl");
  tbl.innerHTML = "";

  const thead = document.createElement("thead");
  const trh = document.createElement("tr");
  headers.forEach(h => {
    const th = document.createElement("th");
    th.textContent = h;
    trh.appendChild(th);
  });
  thead.appendChild(trh);
  tbl.appendChild(thead);

  const tbody = document.createElement("tbody");
  data.slice(0, MAX_ROWS_RENDER).forEach(row => {
    const tr = document.createElement("tr");
    headers.forEach(h => {
      const td = document.createElement("td");
      let val = row[h];
      if (typeof val === "number") val = val.toFixed(2);
      td.textContent = val ?? "";
      if (h.endsWith(Z_COL_SUFFIX)) td.className = bucket(row[h]);
      tr.appendChild(td);
    });
    tbody.appendChild(tr);
  });
  tbl.appendChild(tbody);
}
</script>
</body>
</html>