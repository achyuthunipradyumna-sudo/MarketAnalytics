<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>Breadth Dashboard</title>

<style>
body {
  font-family: -apple-system, BlinkMacSystemFont, Arial, sans-serif;
  margin: 16px;
}

h2 {
  margin-bottom: 8px;
}

.controls {
  margin-bottom: 12px;
}

button, select {
  padding: 6px 10px;
  margin-right: 6px;
  font-size: 14px;
}

table {
  border-collapse: collapse;
  width: 100%;
  font-size: 13px;
}

th, td {
  border: 1px solid #ddd;
  padding: 6px;
  text-align: right;
}

th {
  background: #f3f3f3;
  position: sticky;
  top: 0;
}

td.date {
  text-align: left;
  font-weight: bold;
}

/* COLOR CODING */
.pos { background: #e6f4ea; }     /* green */
.neg { background: #fdecea; }     /* red */
.neutral { background: #f7f7f7; }

.small {
  font-size: 11px;
  color: #555;
}
</style>
</head>

<body>

<h2>Market Breadth Dashboard</h2>

<div class="controls">
  <strong>View:</strong>
  <button onclick="setMode('raw')">Raw</button>
  <button onclick="setMode('z')">Z-Scores</button>

  &nbsp;&nbsp;
  <strong>Lookback:</strong>
  <select onchange="setLookback(this.value)">
    <option value="30">1 Month</option>
    <option value="90">3 Months</option>
    <option value="180">6 Months</option>
    <option value="260">1 Year</option>
    <option value="all" selected>Full History</option>
  </select>
</div>

<div class="small">
  Columns shown depend on selected mode.
</div>

<br>

<table id="breadthTable"></table>

<script>
let RAW = [];
let MODE = "raw";
let LOOKBACK = "all";

fetch("data/history/breadth_full_history.csv")
  .then(r => r.text())
  .then(text => {
    const rows = text.trim().split("\n");
    const header = rows[0].split(",");
    RAW = rows.slice(1).map(r => {
      const v = r.split(",");
      let o = {};
      header.forEach((h, i) => o[h] = v[i]);
      return o;
    });
    render();
  });

function setMode(m) {
  MODE = m;
  render();
}

function setLookback(v) {
  LOOKBACK = v;
  render();
}

function sliceData() {
  if (LOOKBACK === "all") return RAW;
  return RAW.slice(-parseInt(LOOKBACK));
}

function colorClass(val) {
  if (val > 0) return "pos";
  if (val < 0) return "neg";
  return "neutral";
}

function render() {
  const data = sliceData();
  const table = document.getElementById("breadthTable");
  table.innerHTML = "";

  let headers = ["Date"];

  if (MODE === "raw") {
    headers.push(
      "adv","dec","ad",
      "pct_above_20dma","pct_above_20dma_chg",
      "pct_above_50dma","pct_above_50dma_chg",
      "pct_above_200dma","pct_above_200dma_chg",
      "nh","nl","nhnl"
    );
  } else {
    headers.push(
      "ad_z_50",
      "pct_above_20dma_z",
      "pct_above_50dma_z",
      "pct_above_200dma_z",
      "nhnl_z"
    );
  }

  // HEADER
  let tr = document.createElement("tr");
  headers.forEach(h => {
    let th = document.createElement("th");
    th.innerText = h;
    tr.appendChild(th);
  });
  table.appendChild(tr);

  // ROWS
  data.forEach(r => {
    let tr = document.createElement("tr");

    headers.forEach(h => {
      let td = document.createElement("td");

      if (h === "Date") {
        td.innerText = r[h];
        td.className = "date";
      } else {
        let val = parseFloat(r[h]);
        td.innerText = isNaN(val) ? "" : val.toFixed(2);
        td.className = colorClass(val);
      }

      tr.appendChild(td);
    });

    table.appendChild(tr);
  });
}
</script>

</body>
</html>
