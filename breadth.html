<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>Breadth Heatmap</title>

<style>
body {
  font-family: -apple-system, BlinkMacSystemFont, Arial, sans-serif;
  margin: 16px;
}

.controls {
  margin-bottom: 12px;
}

button, select {
  padding: 6px 10px;
  margin-right: 8px;
  font-size: 14px;
}

table {
  border-collapse: collapse;
  width: 100%;
  font-size: 12px;
}

th, td {
  border: 1px solid #ddd;
  padding: 4px;
  text-align: right;
}

th {
  background: #f5f5f5;
  position: sticky;
  top: 0;
}

td.date {
  text-align: left;
  background: #fafafa;
  font-weight: 600;
}

/* Z-score colors */
.z-pos-strong { background: #1b7837; color: white; }
.z-pos { background: #7fbf7b; }
.z-neutral { background: #f7f7f7; }
.z-neg { background: #ef8a62; }
.z-neg-strong { background: #b2182b; color: white; }

/* Raw semantic colors */
.raw-good { background: #1a9850; color: white; }
.raw-ok { background: #91cf60; }
.raw-neutral { background: #f7f7f7; }
.raw-bad { background: #fc8d59; }
.raw-risk { background: #d73027; color: white; }
</style>
</head>

<body>

<h2>Breadth Heatmap</h2>

<div class="controls">
  View:
  <button onclick="setMode('z')">Z-Scores</button>
  <button onclick="setMode('raw')">Raw</button>

  Lookback:
  <select onchange="setLookback(this.value)">
    <option value="21">1 Month</option>
    <option value="63">3 Months</option>
    <option value="126">6 Months</option>
    <option value="252">1 Year</option>
    <option value="all" selected>Full History</option>
  </select>
</div>

<div id="table"></div>

<script>
let DATA = [];
let MODE = "z";
let LOOKBACK = "all";

/* RAW columns ONLY â€” no deltas */
const RAW_COLS = [
  "adv","dec","ad",
  "pct_above_20dma","pct_above_50dma","pct_above_200dma",
  "nh","nl","nhnl",
  "median_stock_vol_20","median_stock_vol_50"
];

const Z_COLS = [
  "ad_z_50",
  "pct_above_20dma_z","pct_above_50dma_z","pct_above_200dma_z",
  "nhnl_z",
  "median_stock_vol_20_z","median_stock_vol_50_z"
];

fetch("data/history/breadth_full_history.csv")
.then(r => r.text())
.then(text => {
  const rows = text.trim().split("\n");
  const headers = rows[0].split(",");
  DATA = rows.slice(1).map(r => {
    const v = r.split(",");
    let o = {};
    headers.forEach((h,i)=>o[h]=v[i]);
    return o;
  });
  render();
});

function setMode(m){ MODE=m; render(); }
function setLookback(l){ LOOKBACK=l; render(); }

/* Z-score coloring */
function zClass(v){
  v = parseFloat(v);
  if (v >= 1.5) return "z-pos-strong";
  if (v >= 0.5) return "z-pos";
  if (v > -0.5) return "z-neutral";
  if (v > -1.5) return "z-neg";
  return "z-neg-strong";
}

/* Raw semantic coloring */
function rawClass(col, v){
  v = parseFloat(v);

  // % participation
  if (col.includes("pct_above")) {
    if (v >= 60) return "raw-good";
    if (v >= 45) return "raw-ok";
    if (v >= 30) return "raw-neutral";
    return "raw-bad";
  }

  // A/D or NHâ€“NL
  if (["ad","nhnl"].includes(col)) {
    if (v > 500) return "raw-good";
    if (v > 0) return "raw-ok";
    if (v > -500) return "raw-neutral";
    return "raw-bad";
  }

  // Volatility (LOW is good)
  if (col.includes("vol")) {
    if (v <= 0.25) return "raw-good";
    if (v <= 0.35) return "raw-ok";
    if (v <= 0.45) return "raw-neutral";
    return "raw-risk";
  }

  return "raw-neutral";
}

function render(){
  let rows = [...DATA];

  if (LOOKBACK !== "all"){
    rows = rows.slice(-parseInt(LOOKBACK));
  }

  // ðŸ”‘ Latest date on TOP
  rows.reverse();

  const cols = MODE==="z" ? Z_COLS : RAW_COLS;

  let html = "<table><tr><th>Date</th>";
  cols.forEach(c=>html+=`<th>${c}</th>`);
  html+="</tr>";

  rows.forEach(r=>{
    html+=`<tr><td class="date">${r.Date}</td>`;
    cols.forEach(c=>{
      const val = r[c] || "";
      const cls = MODE==="z" ? zClass(val) : rawClass(c,val);
      html+=`<td class="${cls}">${val}</td>`;
    });
    html+="</tr>";
  });

  html+="</table>";
  document.getElementById("table").innerHTML = html;
}
</script>

</body>
</html>