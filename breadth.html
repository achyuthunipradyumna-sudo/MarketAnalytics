<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Market Breadth – Colored Table</title>

<style>
body {
  font-family: system-ui, -apple-system, Segoe UI, Arial, sans-serif;
  padding: 16px;
}

h2 {
  margin-bottom: 8px;
}

table {
  border-collapse: collapse;
  font-size: 12px;
}

th, td {
  border: 1px solid #ddd;
  padding: 4px 6px;
  text-align: right;
}

th {
  background: #f5f5f5;
  position: sticky;
  top: 0;
  z-index: 1;
}

td.date {
  text-align: left;
  font-weight: 600;
}

/* smooth color interpolation */
.cell {
  color: #111;
}

/* text contrast for dark cells */
.dark {
  color: #fff;
}
</style>
</head>

<body>

<h2>Market Breadth (Excel-style Gradients)</h2>

<table id="tbl">
<thead>
<tr>
  <th>Date</th>
  <th>%&gt;20DMA</th>
  <th>%&gt;50DMA</th>
  <th>%&gt;200DMA</th>
  <th>Adv</th>
  <th>Dec</th>
  <th>A/D</th>
  <th>NH</th>
  <th>NL</th>
  <th>NH–NL</th>
</tr>
</thead>
<tbody></tbody>
</table>

<script>
const CSV_URL =
  "https://achyuthunipradyumna-sudo.github.io/MarketAnalytics/data/history/breadth_full_history.csv";

const COLS = [
  "Date",
  "pct_above_20dma",
  "pct_above_50dma",
  "pct_above_200dma",
  "adv",
  "dec",
  "ad",
  "nh",
  "nl",
  "nhnl"
];

// linear interpolation between two colors
function lerp(a, b, t) {
  return a + (b - a) * t;
}

function lerpColor(c1, c2, t) {
  return `rgb(
    ${Math.round(lerp(c1[0], c2[0], t))},
    ${Math.round(lerp(c1[1], c2[1], t))},
    ${Math.round(lerp(c1[2], c2[2], t))}
  )`;
}

// Excel-like Red → Yellow → Green
const RED = [215, 48, 39];
const YELLOW = [255, 255, 191];
const GREEN = [26, 152, 80];

// percent scale 0–100
function pctColor(v) {
  if (v <= 50) return lerpColor(RED, YELLOW, v / 50);
  return lerpColor(YELLOW, GREEN, (v - 50) / 50);
}

// centered scale (−M → 0 → +M)
function centeredColor(v, maxAbs) {
  if (v < 0) return lerpColor(RED, YELLOW, (v + maxAbs) / maxAbs);
  return lerpColor(YELLOW, GREEN, v / maxAbs);
}

fetch(CSV_URL)
  .then(r => r.text())
  .then(txt => {
    const lines = txt.trim().split("\n");
    const header = lines[0].split(",");
    const idx = Object.fromEntries(header.map((h, i) => [h, i]));

    const rows = lines.slice(1)
      .map(l => l.split(","))
      .filter(r => r.length === header.length)
      .reverse(); // latest on top

    const tbody = document.querySelector("#tbl tbody");

    rows.forEach(r => {
      const tr = document.createElement("tr");

      COLS.forEach(c => {
        const td = document.createElement("td");
        const val = r[idx[c]];

        if (c === "Date") {
          td.textContent = val;
          td.className = "date";
        } else {
          const num = parseFloat(val);
          td.textContent = num.toFixed(2);

          let bg = null;
          if (c.startsWith("pct_above")) {
            bg = pctColor(num);
          }
          if (c === "ad" || c === "nhnl") {
            bg = centeredColor(num, 2500);
          }

          if (bg) {
            td.style.background = bg;
            td.classList.add("cell");
            if (num < 0 || num > 80) td.classList.add("dark");
          }
        }
        tr.appendChild(td);
      });

      tbody.appendChild(tr);
    });
  });
</script>

</body>
</html>