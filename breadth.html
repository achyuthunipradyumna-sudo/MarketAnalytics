<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Market Breadth – Colored Table</title>

<style>
body {
  font-family: system-ui, -apple-system, Segoe UI, Arial, sans-serif;
  padding: 16px;
}

h2 {
  margin-bottom: 10px;
}

table {
  border-collapse: collapse;
  font-size: 12px;
}

th, td {
  border: 1px solid #ddd;
  padding: 4px 6px;
  text-align: right;
}

th {
  background: #f5f5f5;
  position: sticky;
  top: 0;
  z-index: 1;
}

td.date {
  text-align: left;
  font-weight: 600;
}
</style>
</head>

<body>

<h2>Market Breadth (Excel-style Gradients)</h2>

<table id="tbl">
<thead>
<tr>
  <th>Date</th>
  <th>%&gt;20DMA</th>
  <th>%&gt;50DMA</th>
  <th>%&gt;200DMA</th>
  <th>Adv</th>
  <th>Dec</th>
  <th>A/D</th>
  <th>NH</th>
  <th>NL</th>
  <th>NH–NL</th>
</tr>
</thead>
<tbody></tbody>
</table>

<script>
/* =========================
   CONFIG
========================= */

const CSV_URL =
  "https://achyuthunipradyumna-sudo.github.io/MarketAnalytics/data/history/breadth_full_history.csv";

const COLS = [
  "Date",
  "pct_above_20dma",
  "pct_above_50dma",
  "pct_above_200dma",
  "adv",
  "dec",
  "ad",
  "nh",
  "nl",
  "nhnl"
];

/* =========================
   COLORS
========================= */

// Excel-like gradient for % above DMA
const RED = [215, 48, 39];
const YELLOW = [255, 255, 191];
const GREEN = [26, 152, 80];

// Light sign-based colors for A/D & NH–NL
const LIGHT_GREEN = "rgb(220, 245, 220)";
const LIGHT_RED   = "rgb(245, 220, 220)";

/* =========================
   HELPERS
========================= */

function lerp(a, b, t) {
  return a + (b - a) * t;
}

function lerpColor(c1, c2, t) {
  return `rgb(
    ${Math.round(lerp(c1[0], c2[0], t))},
    ${Math.round(lerp(c1[1], c2[1], t))},
    ${Math.round(lerp(c1[2], c2[2], t))}
  )`;
}

// 0 → 50 → 100 : red → yellow → green
function pctColor(v) {
  if (v <= 50) return lerpColor(RED, YELLOW, v / 50);
  return lerpColor(YELLOW, GREEN, (v - 50) / 50);
}

/* =========================
   MAIN
========================= */

fetch(CSV_URL)
  .then(r => {
    if (!r.ok) throw new Error("CSV not found");
    return r.text();
  })
  .then(text => {
    const lines = text
      .replace(/\r/g, "")
      .split("\n")
      .map(l => l.trim())
      .filter(l => l.length > 0);

    const header = lines[0].split(",");
    const idx = {};
    header.forEach((h, i) => idx[h] = i);

    const tbody = document.querySelector("#tbl tbody");

    // Latest date on top
    lines.slice(1).reverse().forEach(line => {
      const row = line.split(",");
      if (row.length !== header.length) return;

      const tr = document.createElement("tr");

      COLS.forEach(col => {
        const td = document.createElement("td");

        if (col === "Date") {
          td.textContent = row[idx[col]];
          td.className = "date";
        } else {
          const num = parseFloat(row[idx[col]]);
          if (isNaN(num)) {
            td.textContent = "";
          } else {
            td.textContent = num.toFixed(2);

            /* ---- Coloring logic ---- */

            // % Above DMA → gradient
            if (col.startsWith("pct_above")) {
              td.style.background = pctColor(num);
            }

            // A/D & NH–NL → sign only (FIXED)
            if (col === "ad" || col === "nhnl") {
              if (num > 0) td.style.background = LIGHT_GREEN;
              else if (num < 0) td.style.background = LIGHT_RED;
            }
          }
        }

        tr.appendChild(td);
      });

      tbody.appendChild(tr);
    });
  })
  .catch(err => {
    document.body.insertAdjacentHTML(
      "beforeend",
      `<p style="color:red">Error loading CSV: ${err.message}</p>`
    );
  });
</script>

</body>
</html>