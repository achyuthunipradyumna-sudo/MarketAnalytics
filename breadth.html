<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Breadth — Participation & Internal Strength</title>
  <script src="https://cdn.plot.ly/plotly-2.30.0.min.js"></script>
  <style>
    body { font-family: Arial; margin: 20px; }
    .controls button {
      margin-right: 8px;
      padding: 6px 10px;
      cursor: pointer;
    }
  </style>
</head>
<body>

<h2>Breadth — Participation & Internal Strength</h2>

<div class="controls">
  <b>View:</b>
  <button onclick="setMode('z')">Z-Scores</button>
  <button onclick="setMode('raw')">Raw</button>
</div>

<div id="chart"></div>

<script>
const DATA_URL = "data/history/breadth_full_history.csv";
let rows = [];
let mode = "z";

const PLOT_CONFIG = {
  responsive: true,
  scrollZoom: false,
  doubleClick: false,
  displaylogo: false,
  modeBarButtonsToRemove: [
    "zoom2d","select2d","lasso2d",
    "zoomIn2d","zoomOut2d","autoScale2d"
  ]
};

fetch(DATA_URL)
  .then(r => r.text())
  .then(txt => {
    const lines = txt.trim().split("\n");
    const headers = lines[0].split(",");
    rows = lines.slice(1).map(l => {
      const v = l.split(",");
      let o = {};
      headers.forEach((h,i)=>o[h]=+v[i] || v[i]);
      return o;
    });
    render();
  });

function setMode(m) {
  mode = m;
  render();
}

function render() {
  const x = rows.map(r => r.Date);

  const traces = mode === "z" ? [
    { x, y: rows.map(r=>r.ad_z_50), name:"AD Z(50)" },
    { x, y: rows.map(r=>r.pct_above_20dma_z), name:"%>20DMA Z" },
    { x, y: rows.map(r=>r.pct_above_50dma_z), name:"%>50DMA Z" },
    { x, y: rows.map(r=>r.pct_above_200dma_z), name:"%>200DMA Z" },
    { x, y: rows.map(r=>r.nhnl_z), name:"NH–NL Z" }
  ] : [
    { x, y: rows.map(r=>r.ad_z_50), name:"AD (proxy)" },
    { x, y: rows.map(r=>r.pct_above_20dma_chg), name:"%>20DMA Δ" },
    { x, y: rows.map(r=>r.pct_above_50dma_chg), name:"%>50DMA Δ" },
    { x, y: rows.map(r=>r.pct_above_200dma_chg), name:"%>200DMA Δ" }
  ];

  const layout = {
    title: "Breadth",
    hovermode: "x unified",
    dragmode: "pan",
    yaxis: { zeroline: true },
    height: 600
  };

  Plotly.newPlot("chart", traces, layout, PLOT_CONFIG);
}
</script>

</body>
</html>
