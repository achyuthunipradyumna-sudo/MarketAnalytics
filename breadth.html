<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>Market Breadth â€“ Daily Heatmap</title>

<style>
body {
  font-family: -apple-system, BlinkMacSystemFont, Arial, sans-serif;
  margin: 20px;
}

h2 {
  margin-bottom: 10px;
}

.controls {
  margin-bottom: 15px;
}

select, button {
  padding: 6px 10px;
  margin-right: 10px;
  font-size: 14px;
}

table {
  border-collapse: collapse;
  width: 100%;
  font-size: 13px;
}

th, td {
  border: 1px solid #ddd;
  padding: 6px;
  text-align: right;
}

th {
  background: #f3f3f3;
  position: sticky;
  top: 0;
  z-index: 2;
}

td:first-child, th:first-child {
  text-align: left;
  position: sticky;
  left: 0;
  background: #fafafa;
  z-index: 1;
}

.pos { background-color: #c6efce; }
.neg { background-color: #f4c7c3; }
.neu { background-color: #f7f7f7; }
</style>
</head>

<body>

<h2>ðŸ“Š Market Breadth â€“ Daily Heatmap</h2>

<div class="controls">
  <label>View:</label>
  <select id="viewMode">
    <option value="raw">Raw Values</option>
    <option value="z">Z-Scores</option>
  </select>

  <label>Lookback:</label>
  <select id="lookback">
    <option value="22">1 Month</option>
    <option value="66">3 Months</option>
    <option value="132">6 Months</option>
    <option value="252">1 Year</option>
    <option value="all">Full History</option>
  </select>
</div>

<div style="overflow-x:auto">
<table id="breadthTable"></table>
</div>

<script>
const CSV_PATH = "data/history/breadth_full_history.csv";

let rawData = [];

fetch(CSV_PATH)
  .then(r => r.text())
  .then(text => {
    const rows = text.trim().split("\n");
    const headers = rows[0].split(",");
    rawData = rows.slice(1).map(r => {
      const v = r.split(",");
      let o = {};
      headers.forEach((h,i)=>o[h]=v[i]);
      return o;
    });
    render();
  });

function colorClass(val) {
  if (val > 0.5) return "pos";
  if (val < -0.5) return "neg";
  return "neu";
}

function render() {
  const mode = document.getElementById("viewMode").value;
  const lb = document.getElementById("lookback").value;

  let data = rawData;
  if (lb !== "all") data = rawData.slice(-parseInt(lb));

  let cols, headers;

  if (mode === "raw") {
    headers = [
      "Date","A/D",
      "%>20DMA","Î”20DMA",
      "%>50DMA","Î”50DMA",
      "%>200DMA","Î”200DMA",
      "NHâ€“NL"
    ];
    cols = [
      "Date","ad",
      "pct_above_20dma","pct_above_20dma_chg",
      "pct_above_50dma","pct_above_50dma_chg",
      "pct_above_200dma","pct_above_200dma_chg",
      "nhnl"
    ];
  } else {
    headers = [
      "Date","AD Z",
      "%>20DMA Z","%>50DMA Z","%>200DMA Z",
      "NHâ€“NL Z"
    ];
    cols = [
      "Date","ad_z_50",
      "pct_above_20dma_z",
      "pct_above_50dma_z",
      "pct_above_200dma_z",
      "nhnl_z"
    ];
  }

  const table = document.getElementById("breadthTable");
  table.innerHTML = "";

  let thead = "<tr>" + headers.map(h=>`<th>${h}</th>`).join("") + "</tr>";
  table.innerHTML += thead;

  data.forEach(d => {
    let row = "<tr>";
    cols.forEach((c,i)=>{
      let v = d[c];
      if (i===0) {
        row += `<td>${v}</td>`;
      } else {
        let num = parseFloat(v);
        let cls = isNaN(num) ? "neu" : colorClass(num);
        row += `<td class="${cls}">${isNaN(num) ? "" : num.toFixed(2)}</td>`;
      }
    });
    row += "</tr>";
    table.innerHTML += row;
  });
}

document.getElementById("viewMode").onchange = render;
document.getElementById("lookback").onchange = render;
</script>

</body>
</html>