<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Market Breadth – Heatmap</title>

<style>
body {
  font-family: system-ui, -apple-system, Segoe UI, Arial, sans-serif;
  padding: 16px;
}

h2 {
  margin: 0 0 10px 0;
}

.controls {
  margin-bottom: 10px;
}

button {
  padding: 6px 10px;
  margin-right: 6px;
  border: 1px solid #ccc;
  background: #f5f5f5;
  cursor: pointer;
}
button.active {
  background: #ddd;
  font-weight: 600;
}

table {
  border-collapse: collapse;
  font-size: 12px;
}

th, td {
  border: 1px solid #ddd;
  padding: 4px 8px;
  text-align: right;
  min-width: 70px;
}

th {
  background: #f2f2f2;
  position: sticky;
  top: 0;
  z-index: 2;
}

td.date {
  text-align: left;
  font-weight: 600;
  background: #fafafa;
  position: sticky;
  left: 0;
  z-index: 1;
}

/* ===== Excel-exact heatmap buckets ===== */
.bkt-0 { background:#F8696B; }
.bkt-1 { background:#F4A582; }
.bkt-2 { background:#FDDCC8; }
.bkt-3 { background:#FDEEEE; }
.bkt-4 { background:#FFF5F5; }
.bkt-5 { background:#FFFFFF; }
.bkt-6 { background:#F4FBF2; }
.bkt-7 { background:#D9F0D3; }
.bkt-8 { background:#A6D96A; }
.bkt-9 { background:#63BE7B; }
.bkt-10{ background:#3FA35A; }

td {
  color: #000; /* Excel keeps black text */
}
</style>
</head>

<body>

<h2>Market Breadth — Participation & Internal Strength</h2>

<div class="controls">
  View:
  <button onclick="setRange(1)"  id="btn1">1M</button>
  <button onclick="setRange(3)"  id="btn3">3M</button>
  <button onclick="setRange(6)"  id="btn6" class="active">6M</button>
  <button onclick="setRange(12)" id="btn12">1Y</button>
  <button onclick="setRange(36)" id="btn36">3Y</button>
</div>

<table id="heatmap"></table>

<script>
// ================= CONFIG =================
const CSV_PATH = "data/history/breadth_full_history.csv";

const COLUMNS = [
  { key:"pct_above_20dma", label:"% > 20DMA", heat:true },
  { key:"pct_above_50dma", label:"% > 50DMA", heat:true },
  { key:"pct_above_200dma", label:"% > 200DMA", heat:true },
  { key:"adv", label:"Adv" },
  { key:"dec", label:"Dec" },
  { key:"ad", label:"Net A/D" },
  { key:"nh", label:"NH" },
  { key:"nl", label:"NL" },
  { key:"nhnl", label:"NH-NL" }
];

let FULL_DATA = [];
let MONTHS = 6;

// ================= HEATMAP BUCKET =================
function bucket(v) {
  if (v < 10) return 0;
  if (v < 20) return 1;
  if (v < 30) return 2;
  if (v < 40) return 3;
  if (v < 45) return 4;
  if (v <= 55) return 5;
  if (v <= 60) return 6;
  if (v <= 70) return 7;
  if (v <= 80) return 8;
  if (v <= 90) return 9;
  return 10;
}

// ================= CSV PARSE =================
function parseCSV(text) {
  const lines = text.trim().split("\n");
  const headers = lines[0].split(",");
  return lines.slice(1).map(row => {
    const vals = row.split(",");
    const obj = {};
    headers.forEach((h,i)=>obj[h]=vals[i]);
    return obj;
  });
}

// ================= BUILD TABLE =================
function buildTable() {
  const table = document.getElementById("heatmap");
  table.innerHTML = "";

  const thead = document.createElement("thead");
  const htr = document.createElement("tr");

  let th = document.createElement("th");
  th.textContent = "Date";
  htr.appendChild(th);

  COLUMNS.forEach(c=>{
    const th = document.createElement("th");
    th.textContent = c.label;
    htr.appendChild(th);
  });

  thead.appendChild(htr);
  table.appendChild(thead);

  const tbody = document.createElement("tbody");
  const frag = document.createDocumentFragment();

  const cutoff = new Date();
  cutoff.setMonth(cutoff.getMonth() - MONTHS);

  FULL_DATA
    .filter(r => new Date(r.Date) >= cutoff)
    .reverse()
    .forEach(row=>{
      const tr = document.createElement("tr");

      const tdDate = document.createElement("td");
      tdDate.textContent = row.Date;
      tdDate.className = "date";
      tr.appendChild(tdDate);

      COLUMNS.forEach(c=>{
        const td = document.createElement("td");
        const val = parseFloat(row[c.key]);
        if (!isNaN(val)) {
          td.textContent = val.toFixed(2);
          if (c.heat) td.className = "bkt-" + bucket(val);
        }
        tr.appendChild(td);
      });

      frag.appendChild(tr);
    });

  tbody.appendChild(frag);
  table.appendChild(tbody);
}

// ================= RANGE CONTROL =================
function setRange(m) {
  MONTHS = m;
  document.querySelectorAll("button").forEach(b=>b.classList.remove("active"));
  document.getElementById("btn"+m).classList.add("active");
  requestAnimationFrame(buildTable);
}

// ================= LOAD =================
fetch(CSV_PATH)
  .then(r=>r.text())
  .then(t=>{
    FULL_DATA = parseCSV(t);
    buildTable();
  })
  .catch(e=>{
    document.body.innerHTML += "<p style='color:red'>Failed to load CSV</p>";
    console.error(e);
  });
</script>

</body>
</html>