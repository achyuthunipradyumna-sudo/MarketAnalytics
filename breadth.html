<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>Market Breadth â€“ Daily Heatmap</title>

<style>
body {
  font-family: -apple-system, BlinkMacSystemFont, sans-serif;
  margin: 20px;
}

h2 { margin-bottom: 8px; }

.controls {
  margin-bottom: 12px;
}

select {
  padding: 6px;
  font-size: 14px;
  margin-right: 10px;
}

table {
  border-collapse: collapse;
  width: 100%;
  font-size: 13px;
}

th, td {
  border: 1px solid #ddd;
  padding: 6px;
  text-align: right;
}

th {
  background: #f4f4f4;
  position: sticky;
  top: 0;
}

td:first-child, th:first-child {
  text-align: left;
  font-weight: 600;
}

.heat-pos { background-color: #d6f5d6; }
.heat-neg { background-color: #f8d7da; }
.heat-mid { background-color: #ffffff; }
</style>
</head>

<body>

<h2>ðŸ“Š Market Breadth â€” Daily Heatmap</h2>

<div class="controls">
  View:
  <select id="viewSelect">
    <option value="z">Z-Scores</option>
    <option value="raw">Raw Values</option>
  </select>

  Lookback:
  <select id="lookbackSelect">
    <option value="30">1 Month</option>
    <option value="90">3 Months</option>
    <option value="180">6 Months</option>
    <option value="365">1 Year</option>
    <option value="all">Full History</option>
  </select>
</div>

<table id="breadthTable"></table>

<script>
const DATA_URL = "data/history/breadth_full_history.csv";

let rows = [];

fetch(DATA_URL)
  .then(r => r.text())
  .then(text => {
    const lines = text.trim().split("\n");
    const header = lines[0].split(",");
    rows = lines.slice(1).map(l => {
      const v = l.split(",");
      let o = {};
      header.forEach((h,i)=>o[h]=v[i]);
      return o;
    });
    render();
  });

function heatClass(v) {
  if (v === "" || isNaN(v)) return "heat-mid";
  v = parseFloat(v);
  if (v > 0.5) return "heat-pos";
  if (v < -0.5) return "heat-neg";
  return "heat-mid";
}

function render() {
  const view = viewSelect.value;
  const lb = lookbackSelect.value;

  let data = [...rows];
  if (lb !== "all") data = data.slice(-parseInt(lb));

  let cols;
  if (view === "z") {
    cols = [
      ["ad_z_50","AD Z(50)"],
      ["pct_above_20dma_z","%>20DMA Z"],
      ["pct_above_50dma_z","%>50DMA Z"],
      ["pct_above_200dma_z","%>200DMA Z"],
      ["nhnl_z","NHâˆ’NL Z"]
    ];
  } else {
    cols = [
      ["ad","AD"],
      ["pct_above_20dma","%>20DMA"],
      ["pct_above_20dma_chg","Î”20DMA"],
      ["pct_above_50dma","%>50DMA"],
      ["pct_above_50dma_chg","Î”50DMA"],
      ["pct_above_200dma","%>200DMA"],
      ["pct_above_200dma_chg","Î”200DMA"],
      ["nh","NH"],
      ["nl","NL"],
      ["nhnl","NHâˆ’NL"]
    ];
  }

  let html = "<tr><th>Date</th>";
  cols.forEach(c=>html+=`<th>${c[1]}</th>`);
  html += "</tr>";

  data.forEach(r=>{
    html += `<tr><td>${r.Date}</td>`;
    cols.forEach(c=>{
      const v = r[c[0]] ?? "";
      html += `<td class="${heatClass(v)}">${v === "" ? "" : (+v).toFixed(2)}</td>`;
    });
    html += "</tr>";
  });

  breadthTable.innerHTML = html;
}

viewSelect.onchange = render;
lookbackSelect.onchange = render;
</script>

</body>
</html>