<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Breadth Dashboard</title>
  <script src="https://cdn.plot.ly/plotly-2.30.0.min.js"></script>
  <style>
    body { font-family: Arial; margin: 20px; }
    select { padding: 6px; margin-right: 10px; }
    #chart { width: 100%; height: 900px; }
  </style>
</head>
<body>

<h2>Breadth — Market Participation</h2>

<label>Mode:</label>
<select id="mode">
  <option value="z">Z-Scores</option>
  <option value="raw">Raw / %</option>
</select>

<div id="chart"></div>

<script>
const FILE = "data/history/breadth_full_history.csv";

const PLOT_CONFIG = {
  responsive: true,
  scrollZoom: false,
  doubleClick: false,
  displaylogo: false,
  modeBarButtonsToRemove: [
    "zoom2d","select2d","lasso2d",
    "zoomIn2d","zoomOut2d","autoScale2d"
  ]
};

let rows;

fetch(FILE).then(r=>r.text()).then(text=>{
  const lines = text.trim().split("\n");
  const h = lines[0].split(",");
  rows = lines.slice(1).map(l=>{
    const v=l.split(",");
    let o={};
    h.forEach((k,i)=>o[k]=+v[i]||v[i]);
    return o;
  });
  draw();
});

document.getElementById("mode").onchange = draw;

function draw(){
  const mode = document.getElementById("mode").value;
  const x = rows.map(r=>new Date(r.Date));

  const traces = mode==="z" ? [
    {x,y:rows.map(r=>r.ad_z_50),name:"AD Z(50)",line:{width:2}},
    {x,y:rows.map(r=>r.pct_above_50dma_z),name:"%>50DMA Z"},
    {x,y:rows.map(r=>r.pct_above_200dma_z),name:"%>200DMA Z"},
    {x,y:rows.map(r=>r.nhnl_z),name:"NH-NL Z"}
  ] : [
    {x,y:rows.map(r=>r.pct_above_50dma_chg),name:"%>50DMA Δ20d"},
    {x,y:rows.map(r=>r.pct_above_200dma_chg),name:"%>200DMA Δ20d"}
  ];

  const layout = {
    dragmode:"pan",
    hovermode:"x unified",
    title:"Breadth",
    yaxis:{zeroline:true},
    margin:{t:40}
  };

  Plotly.newPlot("chart", traces, layout, PLOT_CONFIG);
}
</script>
</body>
</html>
