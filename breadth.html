<script>
const CSV_PATH = "data/history/breadth_full_history.csv";

const COLUMNS = [
  { key:"pct_above_20dma", label:"% > 20DMA", heat:true },
  { key:"pct_above_50dma", label:"% > 50DMA", heat:true },
  { key:"pct_above_200dma", label:"% > 200DMA", heat:true },
  { key:"adv", label:"Adv" },
  { key:"dec", label:"Dec" },
  { key:"ad", label:"Net A/D" },
  { key:"nh", label:"NH" },
  { key:"nl", label:"NL" },
  { key:"nhnl", label:"NHâ€“NL" }
];

let FULL_DATA = [];
let CACHED_RANGES = {};
let CURRENT_RANGE = 6;

// ================= HEATMAP BUCKET =================
function bucket(v) {
  if (v < 10) return 0;
  if (v < 20) return 1;
  if (v < 30) return 2;
  if (v < 40) return 3;
  if (v < 45) return 4;
  if (v <= 55) return 5;
  if (v <= 60) return 6;
  if (v <= 70) return 7;
  if (v <= 80) return 8;
  if (v <= 90) return 9;
  return 10;
}

// ================= CSV PARSE =================
function parseCSV(text) {
  const lines = text.trim().split("\n");
  const headers = lines[0].split(",");
  return lines.slice(1).map(r => {
    const vals = r.split(",");
    const o = {};
    headers.forEach((h,i)=>o[h]=vals[i]);
    return o;
  });
}

// ================= BUILD HEADER (ONCE) =================
function buildHeader() {
  const table = document.getElementById("heatmap");
  const thead = document.createElement("thead");
  const tr = document.createElement("tr");

  let th = document.createElement("th");
  th.textContent = "Date";
  tr.appendChild(th);

  COLUMNS.forEach(c=>{
    const th = document.createElement("th");
    th.textContent = c.label;
    tr.appendChild(th);
  });

  thead.appendChild(tr);
  table.appendChild(thead);

  table.appendChild(document.createElement("tbody"));
}

// ================= PREPARE RANGES (ONCE) =================
function prepareRanges() {
  const latestDate = new Date(FULL_DATA[FULL_DATA.length - 1].Date);

  [1,3,6,12,36].forEach(m=>{
    const cutoff = new Date(latestDate);
    cutoff.setMonth(cutoff.getMonth() - m);

    CACHED_RANGES[m] = FULL_DATA
      .filter(r => new Date(r.Date) >= cutoff)
      .reverse(); // latest on top
  });
}

// ================= RENDER BODY ONLY =================
function renderBody(months) {
  const tbody = document.querySelector("#heatmap tbody");
  tbody.innerHTML = "";

  const frag = document.createDocumentFragment();

  CACHED_RANGES[months].forEach(row=>{
    const tr = document.createElement("tr");

    const tdDate = document.createElement("td");
    tdDate.textContent = row.Date;
    tdDate.className = "date";
    tr.appendChild(tdDate);

    COLUMNS.forEach(c=>{
      const td = document.createElement("td");
      const v = parseFloat(row[c.key]);

      if (!isNaN(v)) {
        td.textContent = c.heat ? v.toFixed(2) : Math.round(v);
        if (c.heat) td.className = "bkt-" + bucket(v);
      }
      tr.appendChild(td);
    });

    frag.appendChild(tr);
  });

  tbody.appendChild(frag);
}

// ================= RANGE CONTROL =================
function setRange(m) {
  CURRENT_RANGE = m;
  document.querySelectorAll("button").forEach(b=>b.classList.remove("active"));
  document.getElementById("btn"+m).classList.add("active");
  requestAnimationFrame(()=>renderBody(m));
}

// ================= LOAD =================
fetch(CSV_PATH)
  .then(r=>r.text())
  .then(text=>{
    FULL_DATA = parseCSV(text);
    buildHeader();
    prepareRanges();
    renderBody(CURRENT_RANGE);
  })
  .catch(e=>{
    document.body.innerHTML += "<p style='color:red'>CSV load failed</p>";
    console.error(e);
  });
</script>