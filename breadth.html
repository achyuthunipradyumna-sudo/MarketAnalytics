<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Market Breadth – Base Heatmap</title>

<style>
body {
  font-family: system-ui, -apple-system, Segoe UI, Arial, sans-serif;
  padding: 16px;
}

h2 {
  margin-bottom: 10px;
}

table {
  border-collapse: collapse;
  font-size: 12px;
}

th, td {
  border: 1px solid #ddd;
  padding: 4px 6px;
  text-align: right;
}

th {
  background: #f5f5f5;
  position: sticky;
  top: 0;
  z-index: 1;
}

td.date {
  text-align: left;
  font-weight: 600;
  white-space: nowrap;
}
</style>
</head>

<body>

<h2>Market Breadth – Base (Excel-style Gradients)</h2>

<table id="tbl">
<thead>
<tr>
  <th>Date</th>

  <!-- Participation -->
  <th>Adv %</th>
  <th>Dec %</th>
  <th>Unch %</th>

  <!-- Trend -->
  <th>%&gt;20DMA</th>
  <th>%&gt;50DMA</th>
  <th>%&gt;200DMA</th>

  <!-- Return buckets -->
  <th>&gt;5%</th>
  <th>4–5%</th>
  <th>3–4%</th>
  <th>2–3%</th>
  <th>1–2%</th>
  <th>0–1%</th>
  <th>-1–0%</th>
  <th>-2–-1%</th>
  <th>-3–-2%</th>
  <th>-4–-3%</th>
  <th>-5–-4%</th>
  <th>&lt;-5%</th>

  <!-- Breakouts -->
  <th>H20</th>
  <th>L20</th>
  <th>Δ20</th>

  <th>H63</th>
  <th>L63</th>
  <th>Δ63</th>

  <th>H126</th>
  <th>L126</th>
  <th>Δ126</th>

  <th>NH</th>
  <th>NL</th>
  <th>Δ252</th>
</tr>
</thead>
<tbody></tbody>
</table>

<script>
/* =========================
   CONFIG
========================= */

const CSV_URL =
  "https://achyuthunipradyumna-sudo.github.io/MarketAnalytics/data/history/breadth_base.csv";

const COLS = [
  "Date",

  "adv_pct", "dec_pct", "unch_pct",

  "pct_above_20dma", "pct_above_50dma", "pct_above_200dma",

  "ret_gt_5_pct", "ret_4_5_pct", "ret_3_4_pct", "ret_2_3_pct",
  "ret_1_2_pct", "ret_0_1_pct",
  "ret_m1_0_pct", "ret_m2_m1_pct", "ret_m3_m2_pct",
  "ret_m4_m3_pct", "ret_m5_m4_pct", "ret_lt_m5_pct",

  "high_20d_pct", "low_20d_pct", "hl_diff_20d_pct",
  "high_63d_pct", "low_63d_pct", "hl_diff_63d_pct",
  "high_126d_pct", "low_126d_pct", "hl_diff_126d_pct",
  "high_252d_pct", "low_252d_pct", "hl_diff_252d_pct"
];

/* =========================
   COLORS (UNCHANGED)
========================= */

// Excel-like gradient for percentages
const RED = [215, 48, 39];
const YELLOW = [255, 255, 191];
const GREEN = [26, 152, 80];

// Light sign-based colors
const LIGHT_GREEN = "rgb(220, 245, 220)";
const LIGHT_RED   = "rgb(245, 220, 220)";

/* =========================
   HELPERS (UNCHANGED)
========================= */

function lerp(a, b, t) {
  return a + (b - a) * t;
}

function lerpColor(c1, c2, t) {
  return `rgb(
    ${Math.round(lerp(c1[0], c2[0], t))},
    ${Math.round(lerp(c1[1], c2[1], t))},
    ${Math.round(lerp(c1[2], c2[2], t))}
  )`;
}

// 0 → 50 → 100 : red → yellow → green
function pctColor(v) {
  if (v <= 50) return lerpColor(RED, YELLOW, v / 50);
  return lerpColor(YELLOW, GREEN, (v - 50) / 50);
}

/* =========================
   MAIN
========================= */

fetch(CSV_URL)
  .then(r => {
    if (!r.ok) throw new Error("CSV not found");
    return r.text();
  })
  .then(text => {
    const lines = text
      .replace(/\r/g, "")
      .split("\n")
      .map(l => l.trim())
      .filter(l => l.length > 0);

    const header = lines[0].split(",");
    const idx = {};
    header.forEach((h, i) => idx[h] = i);

    const tbody = document.querySelector("#tbl tbody");

    // Latest date already on top in CSV
    lines.slice(1).forEach(line => {
      const row = line.split(",");
      if (row.length !== header.length) return;

      const tr = document.createElement("tr");

      COLS.forEach(col => {
        const td = document.createElement("td");

        if (col === "Date") {
          td.textContent = row[idx[col]];
          td.className = "date";
        } else {
          const num = parseFloat(row[idx[col]]);
          if (isNaN(num)) {
            td.textContent = "";
          } else {
            td.textContent = num.toFixed(2);

            /* ---- Coloring logic (NO NEW COLORS) ---- */

            // Percent-type → gradient
            if (
              col.includes("pct") &&
              !col.includes("hl_diff")
            ) {
              td.style.background = pctColor(num);
            }

            // HL diff → sign only
            if (col.startsWith("hl_diff")) {
              if (num > 0) td.style.background = LIGHT_GREEN;
              else if (num < 0) td.style.background = LIGHT_RED;
            }
          }
        }

        tr.appendChild(td);
      });

      tbody.appendChild(tr);
    });
  })
  .catch(err => {
    document.body.insertAdjacentHTML(
      "beforeend",
      `<p style="color:red">Error loading CSV: ${err.message}</p>`
    );
  });
</script>

</body>
</html>
