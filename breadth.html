<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Market Breadth Heat Map</title>

<style>
  body {
    font-family: Arial, sans-serif;
    padding: 16px;
  }

  h3 {
    margin-bottom: 8px;
  }

  table {
    border-collapse: collapse;
    font-size: 13px;
  }

  th, td {
    border: 1px solid #ddd;
    padding: 6px 10px;
    text-align: right;
    min-width: 90px;
  }

  th {
    background: #f5f5f5;
    text-align: center;
    position: sticky;
    top: 0;
    z-index: 1;
  }

  td.date {
    text-align: left;
    font-weight: 600;
    background: #fafafa;
    position: sticky;
    left: 0;
    z-index: 1;
  }
</style>
</head>

<body>

<h3>Market Breadth â€“ % Stocks Above DMA</h3>

<table id="heatmap"></table>

<script>
// ===================================
// CONFIG
// ===================================
const CSV_PATH = "data/history/breadth_full_history.csv";

// Columns to show (order matters)
const COLUMNS = [
  { key: "pct_above_20dma", label: "% > 20 DMA" },
  { key: "pct_above_50dma", label: "% > 50 DMA" },
  { key: "pct_above_200dma", label: "% > 200 DMA" }
];

// ===================================
// EXCEL-STYLE PASTEL COLOR SCALE
// ===================================
function heatColor(v) {
  if (v < 10)  return "#F8696B";
  if (v < 20)  return "#F4A582";
  if (v < 30)  return "#FDDCC8";
  if (v < 40)  return "#FDEEEE";
  if (v < 45)  return "#FFF5F5";
  if (v <= 55) return "#FFFFFF"; // Excel neutral
  if (v <= 60) return "#F4FBF2";
  if (v <= 70) return "#D9F0D3";
  if (v <= 80) return "#A6D96A";
  if (v <= 90) return "#63BE7B";
  return "#3FA35A";
}

function textColor(v) {
  return (v >= 45 && v <= 55) ? "#000000" : "#000000";
}

// ===================================
// CSV PARSER
// ===================================
function parseCSV(text) {
  const lines = text.trim().split("\n");
  const headers = lines[0].split(",");
  return lines.slice(1).map(line => {
    const values = line.split(",");
    const obj = {};
    headers.forEach((h, i) => obj[h.trim()] = values[i]?.trim());
    return obj;
  });
}

// ===================================
// BUILD TABLE
// ===================================
function buildTable(data) {
  const table = document.getElementById("heatmap");
  table.innerHTML = "";

  // Header
  const thead = document.createElement("thead");
  const hrow = document.createElement("tr");

  const thDate = document.createElement("th");
  thDate.textContent = "Date";
  hrow.appendChild(thDate);

  COLUMNS.forEach(c => {
    const th = document.createElement("th");
    th.textContent = c.label;
    hrow.appendChild(th);
  });

  thead.appendChild(hrow);
  table.appendChild(thead);

  // Body
  const tbody = document.createElement("tbody");

  // Latest date on top
  data.reverse().forEach(row => {
    const tr = document.createElement("tr");

    const tdDate = document.createElement("td");
    tdDate.textContent = row.Date;
    tdDate.className = "date";
    tr.appendChild(tdDate);

    COLUMNS.forEach(c => {
      const val = parseFloat(row[c.key]);
      const td = document.createElement("td");

      if (!isNaN(val)) {
        td.textContent = val.toFixed(2);
        td.style.backgroundColor = heatColor(val);
        td.style.color = textColor(val);
      } else {
        td.textContent = "";
      }

      tr.appendChild(td);
    });

    tbody.appendChild(tr);
  });

  table.appendChild(tbody);
}

// ===================================
// LOAD CSV
// ===================================
fetch(CSV_PATH)
  .then(resp => {
    if (!resp.ok) throw new Error("Failed to load CSV");
    return resp.text();
  })
  .then(text => buildTable(parseCSV(text)))
  .catch(err => {
    document.body.innerHTML += "<p style='color:red'>Error loading CSV</p>";
    console.error(err);
  });
</script>

</body>
</html>