<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>Market Breadth — Daily State</title>

<style>
body {
  font-family: -apple-system, BlinkMacSystemFont, Arial, sans-serif;
  margin: 16px;
}

h2 { margin-bottom: 8px; }

.controls {
  margin-bottom: 12px;
}

select, button {
  padding: 6px 10px;
  font-size: 14px;
  margin-right: 6px;
}

table {
  border-collapse: collapse;
  width: 100%;
  font-size: 13px;
}

th, td {
  border: 1px solid #ddd;
  padding: 6px;
  text-align: right;
}

th {
  background: #f4f4f4;
  position: sticky;
  top: 0;
  z-index: 2;
}

td:first-child, th:first-child {
  text-align: left;
  font-weight: bold;
}

.pos { background-color: #dff5e1; }
.neg { background-color: #f8d7da; }
.neu { background-color: #f0f0f0; }
</style>
</head>

<body>

<h2>Market Breadth — Participation & Internal Strength</h2>

<div class="controls">
  View:
  <select id="viewMode">
    <option value="raw">Raw Values</option>
    <option value="z">Z-Scores</option>
    <option value="chg">Δ (20-Day Change)</option>
  </select>

  Lookback:
  <select id="lookback">
    <option value="30">1 Month</option>
    <option value="90">3 Months</option>
    <option value="180">6 Months</option>
    <option value="365">1 Year</option>
    <option value="all">Full History</option>
  </select>
</div>

<div id="table"></div>

<script>
const DATA_URL = "data/history/breadth_full_history.csv";

const VIEWS = {
  raw: [
    ["adv","Adv"],
    ["dec","Dec"],
    ["ad","Net A/D"],
    ["pct_above_20dma","% >20DMA"],
    ["pct_above_50dma","% >50DMA"],
    ["pct_above_200dma","% >200DMA"],
    ["nh","NH"],
    ["nl","NL"],
    ["nhnl","Net NH–NL"]
  ],
  z: [
    ["ad_z_50","AD Z(50)"],
    ["pct_above_20dma_z","%>20DMA Z"],
    ["pct_above_50dma_z","%>50DMA Z"],
    ["pct_above_200dma_z","%>200DMA Z"],
    ["nhnl_z","NH–NL Z"]
  ],
  chg: [
    ["pct_above_20dma_chg","Δ %>20DMA"],
    ["pct_above_50dma_chg","Δ %>50DMA"],
    ["pct_above_200dma_chg","Δ %>200DMA"]
  ]
};

let rows = [];

fetch(DATA_URL)
  .then(r => r.text())
  .then(text => {
    const lines = text.trim().split("\n");
    const header = lines[0].split(",");
    rows = lines.slice(1).map(l => {
      const v = l.split(",");
      let o = {};
      header.forEach((h,i)=>o[h]=v[i]);
      return o;
    });
    render();
  });

function colorClass(v){
  v = parseFloat(v);
  if (isNaN(v)) return "";
  if (v > 0) return "pos";
  if (v < 0) return "neg";
  return "neu";
}

function render(){
  const view = document.getElementById("viewMode").value;
  const look = document.getElementById("lookback").value;
  const cols = VIEWS[view];

  let data = rows;
  if (look !== "all") data = rows.slice(-parseInt(look));

  let html = "<table><thead><tr><th>Date</th>";
  cols.forEach(c => html += `<th>${c[1]}</th>`);
  html += "</tr></thead><tbody>";

  data.forEach(r=>{
    html += `<tr><td>${r.Date}</td>`;
    cols.forEach(c=>{
      const v = r[c[0]];
      html += `<td class="${colorClass(v)}">${v ?? ""}</td>`;
    });
    html += "</tr>";
  });

  html += "</tbody></table>";
  document.getElementById("table").innerHTML = html;
}

document.getElementById("viewMode").onchange = render;
document.getElementById("lookback").onchange = render;
</script>

</body>
</html>