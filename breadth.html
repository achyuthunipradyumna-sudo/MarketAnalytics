<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Breadth Dashboard</title>
  <script src="https://cdn.plot.ly/plotly-2.30.0.min.js"></script>
  <style>
    body { font-family: Arial; margin: 20px; }
    select { margin-right: 10px; padding: 6px; }
    #chart { width: 100%; height: 900px; }
  </style>
</head>
<body>

<h2>Market Breadth</h2>

<select id="range">
  <option value="30">1M</option>
  <option value="90">3M</option>
  <option value="180">6M</option>
  <option value="365">1Y</option>
  <option value="1095">3Y</option>
  <option value="1825">5Y</option>
  <option value="all">Full</option>
</select>

<select id="mode">
  <option value="z">Z-Scores</option>
  <option value="raw">Raw</option>
</select>

<div id="chart"></div>

<script>
const FILE = "data/history/breadth_full_history.csv";
let rows;

fetch(FILE).then(r => r.text()).then(text => {
  const lines = text.trim().split("\n");
  const h = lines[0].split(",");
  rows = lines.slice(1).map(l => {
    const v = l.split(",");
    let o = {};
    h.forEach((k,i)=>o[k]=v[i]);
    return o;
  });
  render();
});

function slice(days){
  if(days==="all") return rows;
  return rows.slice(-days);
}

function render(){
  const days = document.getElementById("range").value;
  const mode = document.getElementById("mode").value;
  const d = slice(days);
  const x = d.map(r => r.Date);

  const traces = [
    {
      x, y: d.map(r => +r.ad_z_50),
      name: "Advance–Decline Z",
      visible: mode==="z"
    },
    {
      x, y: d.map(r => +r.pct_above_50dma_z),
      name: "% > 50 DMA Z",
      visible: mode==="z"
    },
    {
      x, y: d.map(r => +r.nhnl_z),
      name: "NH–NL Z",
      visible: mode==="z"
    }
  ];

  const layout = {
    title: "Breadth (Participation)",
    dragmode: "pan",
    hovermode: "x unified",
    yaxis: { zeroline: true },
    margin: { t: 40 }
  };

  Plotly.newPlot("chart", traces, layout, {
    responsive:true,
    scrollZoom:false,
    displaylogo:false
  });
}

document.getElementById("range").onchange = render;
document.getElementById("mode").onchange = render;
</script>

</body>
</html>
