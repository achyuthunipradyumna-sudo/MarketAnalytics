<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>Breadth</title>
<script src="https://cdn.plot.ly/plotly-2.30.0.min.js"></script>
</head>
<body>

<h2>Breadth Dashboard</h2>

<label>View:</label>
<label><input type="radio" name="mode" value="z" checked>Z-Scores</label>
<label><input type="radio" name="mode" value="raw">Raw</label>

<div id="chart" style="height:800px;"></div>

<script>
const FILE = "data/history/breadth_full_history.csv";
let rows = [];

fetch(FILE).then(r=>r.text()).then(t=>{
  const lines = t.trim().split("\n");
  const h = lines[0].split(",");
  rows = lines.slice(1).map(r=>{
    const v = r.split(",");
    let o={}; h.forEach((k,i)=>o[k]=v[i]); return o;
  });
  draw();
});

function draw(){
  const mode = document.querySelector('input[name="mode"]:checked').value;
  const x = rows.map(d=>d.Date);

  const traces = [
    {
      x, y: rows.map(d=>+d.ad_z_50),
      name:"Advance–Decline Z",
      visible: mode==="z"
    },
    {
      x, y: rows.map(d=>+d.pct_above_20dma_z),
      name:"%>20DMA Z",
      visible: mode==="z"
    },
    {
      x, y: rows.map(d=>+d.pct_above_50dma_z),
      name:"%>50DMA Z",
      visible: mode==="z"
    },
    {
      x, y: rows.map(d=>+d.pct_above_200dma_z),
      name:"%>200DMA Z",
      visible: mode==="z"
    },
    {
      x, y: rows.map(d=>+d.nhnl_z),
      name:"NH–NL Z",
      visible: mode==="z"
    }
  ];

  Plotly.newPlot("chart", traces, {
    title:"Market Breadth",
    hovermode:"x unified",
    yaxis:{zeroline:true},
    legend:{orientation:"h"}
  }, CONFIG);
}

document.querySelectorAll("input[name='mode']")
  .forEach(r=>r.onchange=draw);
</script>

</body>
</html>
